name: Deploy Juice Shop Locally in CI

on:
  workflow_dispatch:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    services:
      juice-shop:
        image: bkimminich/juice-shop
        ports:
          - 3000:3000
        options: >-
          --health-cmd="curl -f http://localhost:3000 || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Wait for Juice Shop to be Ready
      run: |
        echo "Waiting for Juice Shop to start..."
        sleep 15
        curl --retry 5 --retry-connrefused --retry-delay 5 http://localhost:3000

    - name: Confirm Deployment Successful
      run: |
        echo "Juice Shop is running!"
        curl http://localhost:3000 | grep "OWASP Juice Shop" || exit 1
